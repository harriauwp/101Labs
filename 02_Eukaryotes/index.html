<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CH₂O Arcade: Fixed Edition</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #ffffff;
            --lvl0-green: #00e676;
            --lvl1-yellow: #ffea00;
            --lvl2-orange: #ff9100;
            --lvl3-blue: #2979ff;
            --lvl4-purple: #d500f9;
            --lvl5-red: #ff1744;
            --correct: #00c853;
            --wrong: #d50000;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* --- Header & HUD --- */
        header {
            background: var(--panel-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #333;
            z-index: 10;
        }

        /* --- New Dedicated Instruction Bar --- */
        #instruction-bar {
            background: #2a2a2a;
            border-bottom: 1px solid #444;
            padding: 15px;
            text-align: center;
            color: var(--lvl1-yellow);
            font-weight: bold;
            font-size: 1.1em;
            min-height: 24px;
            z-index: 9;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .hud-stat {
            font-weight: bold;
        }

        #xp-bar-container {
            width: 200px;
            height: 10px;
            background: #333;
            border-radius: 5px;
            overflow: hidden;
        }

        #xp-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--lvl0-green), var(--lvl5-red));
            transition: width 0.5s;
        }

        /* --- Main Game Area --- */
        #game-stage {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #252525 0%, #121212 100%);
            overflow: hidden;
        }

        /* --- SVG Styles --- */
        svg {
            width: 100%;
            height: 100%;
            max-width: 900px;
            max-height: 700px;
        }

        .atom {
            cursor: pointer;
            transition: all 0.2s;
        }

        .atom circle {
            fill: #333;
            stroke: #fff;
            stroke-width: 2px;
        }

        .atom text {
            font-family: sans-serif;
            font-size: 14px;
            fill: #fff;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }

        .bond {
            stroke: #fff;
            stroke-width: 2px;
        }

        /* Interaction States */
        .atom:hover circle {
            fill: #555;
            stroke: var(--lvl3-blue);
            transform: scale(1.1);
        }

        .atom.selected circle {
            fill: var(--lvl3-blue);
        }

        .atom.correct circle {
            fill: var(--correct);
            stroke: var(--correct);
        }

        .atom.wrong circle {
            fill: var(--wrong);
            stroke: var(--wrong);
        }

        /* Target Hint Animation for stuck students */
        @keyframes pulse {
            0% {
                stroke-width: 2px;
                stroke: #fff;
            }

            50% {
                stroke-width: 4px;
                stroke: var(--lvl1-yellow);
            }

            100% {
                stroke-width: 2px;
                stroke: #fff;
            }
        }

        .target-bond circle {
            animation: pulse 2s infinite;
        }

        /* --- UI Overlay Panels --- */
        .panel {
            position: absolute;
            background: rgba(30, 30, 30, 0.98);
            border: 2px solid #fff;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .panel.active {
            display: block;
            animation: popIn 0.3s ease;
        }

        .btn {
            background: #333;
            color: white;
            border: 1px solid #fff;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn:hover {
            background: #555;
        }

        /* Level Colors */
        .lvl0 {
            border-color: var(--lvl0-green);
            color: var(--lvl0-green);
        }

        .lvl1 {
            border-color: var(--lvl1-yellow);
            color: var(--lvl1-yellow);
        }

        .lvl2 {
            border-color: var(--lvl2-orange);
            color: var(--lvl2-orange);
        }

        .lvl3 {
            border-color: var(--lvl3-blue);
            color: var(--lvl3-blue);
        }

        .lvl4 {
            border-color: var(--lvl4-purple);
            color: var(--lvl4-purple);
        }

        .lvl5 {
            border-color: var(--lvl5-red);
            color: var(--lvl5-red);
        }

        /* --- Level Selector (Bottom) --- */
        #level-select {
            display: flex;
            justify-content: center;
            background: var(--panel-bg);
            padding: 15px;
            border-top: 1px solid #333;
        }

        .lvl-node {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #555;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            cursor: not-allowed;
            opacity: 0.5;
            font-weight: bold;
        }

        .lvl-node.unlocked {
            cursor: pointer;
            opacity: 1;
            border-color: #fff;
        }

        .lvl-node.completed {
            background: #333;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <header>
        <div>
            <span style="font-size: 1.2em; font-weight:bold;">CH₂O ARCADE</span>
            <span id="molecule-name" style="margin-left: 20px; color: #888;">Raw Atoms</span>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="xp-bar-container">
                <div id="xp-bar"></div>
            </div>
            <span id="score" class="hud-stat">XP: 0</span>
        </div>
    </header>

    <div id="instruction-bar">Initialize System...</div>

    <div id="game-stage">
        <svg id="chem-canvas" viewBox="0 0 800 600"></svg>

        <div id="modal" class="panel active">
            <h2 id="modal-title" class="lvl0">WELCOME TO THE LAB</h2>
            <p id="modal-text">You start as raw atoms. Prove your mastery of Carbon, Hydrogen, and Oxygen to evolve into
                complex polysaccharides.</p>
            <button class="btn" onclick="Game.startLevel(0)">START LEVEL 0</button>
        </div>

        <div id="boss-modal" class="panel">
            <h2 style="color: var(--lvl5-red);">BOSS BATTLE</h2>
            <p id="boss-question">Question goes here...</p>
            <div id="boss-options"></div>
        </div>
    </div>

    <div id="level-select">
        <div class="lvl-node lvl0 unlocked" onclick="Game.startLevel(0)">0</div>
        <div class="lvl-node lvl1" id="btn-lvl-1" onclick="Game.startLevel(1)">1</div>
        <div class="lvl-node lvl2" id="btn-lvl-2" onclick="Game.startLevel(2)">2</div>
        <div class="lvl-node lvl3" id="btn-lvl-3" onclick="Game.startLevel(3)">3</div>
        <div class="lvl-node lvl4" id="btn-lvl-4" onclick="Game.startLevel(4)">4</div>
        <div class="lvl-node lvl5" id="btn-lvl-5" onclick="Game.startLevel(5)">5</div>
    </div>

    <script>
        /** * GAME ENGINE 
         * Handles state, rendering, and logic
         */
        const Game = {
            state: {
                level: 0,
                score: 0,
                unlocked: 0, // Set to 4 to test Level 4 immediately if needed
                clicks: 0
            },

            // --- Configuration Data ---
            levels: [
                {
                    id: 0,
                    title: "LEVEL 0: CH₂O Bootcamp",
                    color: "var(--lvl0-green)",
                    intro: "Task: Identify the Hydroxyl Groups (-OH). Click all of them.",
                },
                {
                    id: 1,
                    title: "LEVEL 1: Functional Group Forge",
                    color: "var(--lvl1-yellow)",
                    intro: "Task: Find the Aldehyde Group (C=O at the end) in Glucose.",
                },
                {
                    id: 2,
                    title: "LEVEL 2: Carbon Counter Lab",
                    color: "var(--lvl2-orange)",
                    intro: "Task: Click Carbon 1 through 6 in the correct order.",
                },
                {
                    id: 3,
                    title: "LEVEL 3: Ring Builder Arena",
                    color: "var(--lvl3-blue)",
                    intro: "Task: Select ALPHA Glucose (OH pointing DOWN).",
                },
                {
                    id: 4,
                    title: "LEVEL 4: Bond Smith Workshop",
                    color: "var(--lvl4-purple)",
                    intro: "Task: Create Maltose. Click OH on C1 (Left) and OH on C4 (Right).",
                },
                {
                    id: 5,
                    title: "LEVEL 5: Polymer Architect",
                    color: "var(--lvl5-red)",
                    intro: "Task: Build Glycogen. Add linear chains and branches.",
                }
            ],

            init() {
                this.svg = document.getElementById('chem-canvas');
                this.updateUI();
            },

            setInstruction(text) {
                document.getElementById('instruction-bar').innerText = text;
            },

            startLevel(n) {
                if (n > this.state.unlocked) return;
                this.state.level = n;
                this.state.clicks = 0;

                // UI Reset
                document.getElementById('modal').classList.remove('active');
                document.getElementById('boss-modal').classList.remove('active');

                const lvlInfo = this.levels[n];
                document.getElementById('molecule-name').innerText = lvlInfo.title;
                document.getElementById('molecule-name').style.color = lvlInfo.color;

                // Permanent Instruction
                this.setInstruction(lvlInfo.intro);

                // Render Level Specifics
                this.renderLevel(n);
            },

            renderLevel(n) {
                this.svg.innerHTML = ''; // Clear canvas

                if (n === 0) {
                    // Level 0: Hydroxyl Hunt
                    this.drawMolecule(400, 100, 'linear_glucose');
                    this.setupClickEvents('hydroxyl');
                }
                else if (n === 1) {
                    // Level 1: Aldehyde ID
                    this.drawMolecule(250, 100, 'linear_glucose');
                    this.drawMolecule(550, 100, 'linear_fructose');
                    this.setupClickEvents('aldehyde');
                }
                else if (n === 2) {
                    // Level 2: Carbon Counting
                    this.drawMolecule(400, 100, 'linear_glucose_numbered');
                    this.state.targetCarbon = 1;
                }
                else if (n === 3) {
                    // Level 3: Alpha vs Beta
                    this.drawMolecule(250, 200, 'alpha_glucose', 'mol-alpha');
                    this.drawMolecule(550, 200, 'beta_glucose', 'mol-beta');

                    // Add custom listeners for whole molecule selection
                    document.getElementById('mol-alpha').addEventListener('click', () => this.levelComplete());
                    document.getElementById('mol-beta').addEventListener('click', () => {
                        this.setInstruction("Wrong! Beta has OH UP (think Balloon). Try again.");
                        this.shakeEffect();
                    });
                }
                else if (n === 4) {
                    // Level 4: Bonding - THE FIX
                    // We draw two molecules with specific IDs so we can target their atoms
                    this.drawMolecule(300, 250, 'alpha_glucose', 'glucose-left');
                    this.drawMolecule(500, 250, 'alpha_glucose', 'glucose-right');

                    this.setupBondingEvents();
                }
                else if (n === 5) {
                    // Level 5: Polymer
                    this.svg.innerHTML = `
                <text x="400" y="50" fill="white" text-anchor="middle" font-size="20">BUILD GLYCOGEN</text>
                <g id="polymer-chain" transform="translate(100, 300)"></g>
                <rect x="250" y="450" width="140" height="50" fill="#333" stroke="white" rx="5" style="cursor:pointer" onclick="Game.addMonomer('linear')"/>
                <text x="320" y="480" fill="white" text-anchor="middle" pointer-events="none" font-weight="bold">+ α(1-4)</text>
                <rect x="410" y="450" width="140" height="50" fill="#333" stroke="white" rx="5" style="cursor:pointer" onclick="Game.addMonomer('branch')"/>
                <text x="480" y="480" fill="white" text-anchor="middle" pointer-events="none" font-weight="bold">+ α(1-6)</text>
            `;
                    this.state.polymerCount = 0;
                    this.addMonomer('start');
                }
            },

            // --- Interaction Logic ---

            setupClickEvents(targetType) {
                const atoms = document.querySelectorAll('.atom');
                let remainingTargets = 0;

                atoms.forEach(atom => {
                    const type = atom.getAttribute('data-type');
                    if (type === targetType) remainingTargets++;

                    atom.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const clickedType = e.currentTarget.getAttribute('data-type');
                        if (clickedType === targetType) {
                            if (!e.currentTarget.classList.contains('correct')) {
                                e.currentTarget.classList.add('correct');
                                remainingTargets--;
                                if (remainingTargets === 0) {
                                    setTimeout(() => this.levelComplete(), 500);
                                }
                            }
                        } else {
                            e.currentTarget.classList.add('wrong');
                            this.shakeEffect();
                            this.setInstruction("Incorrect group! Try again.");
                        }
                    });
                });
            },

            handleCarbonClick(index, element) {
                if (this.state.level !== 2) return;

                if (index === this.state.targetCarbon) {
                    element.classList.add('correct');
                    // Add label
                    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    text.setAttribute("x", parseFloat(element.querySelector('circle').getAttribute('cx')) + 25);
                    text.setAttribute("y", element.querySelector('circle').getAttribute('cy'));
                    text.setAttribute("fill", "#00e676");
                    text.setAttribute("font-weight", "bold");
                    text.textContent = "C" + index;
                    this.svg.appendChild(text);

                    this.state.targetCarbon++;
                    if (this.state.targetCarbon > 6) {
                        setTimeout(() => this.levelComplete(), 500);
                    }
                } else {
                    this.setInstruction(`Look for C${this.state.targetCarbon}! (Top is C1 in Aldehydes)`);
                    this.shakeEffect();
                }
            },

            setupBondingEvents() {
                // 1. Identify the Target Atoms Logic
                // In our drawing logic, the OH pointing DOWN on the RIGHT side is C1.
                // The OH pointing DOWN on the LEFT side is C4.

                const leftMol = document.getElementById('glucose-left');
                const rightMol = document.getElementById('glucose-right');

                // We find the specific child nodes based on their attributes set in drawMolecule
                // This is robust because we are querying the specific molecule Group

                // Find C1-OH on Left Molecule (The only OH on the far right X=100 side of the ring)
                // In our drawMolecule alpha logic, C1 is drawn at x=100. The OH is at x=100.
                // We look for the group transformed to translate(100, 110)
                const target1 = leftMol.querySelector('g[transform="translate(100,110)"]');

                // Find C4-OH on Right Molecule (The OH on the far left X=0 side of the ring)
                // In our drawMolecule logic, C4 is at x=0. The OH is at x=0.
                // We look for group transformed to translate(0, 110)
                const target2 = rightMol.querySelector('g[transform="translate(0,110)"]');

                if (target1) target1.classList.add('target-bond');
                if (target2) target2.classList.add('target-bond');

                // Add Click Listeners to ALL hydroxyls to handle right/wrong
                const hydroxyls = document.querySelectorAll('.atom[data-type="hydroxyl"]');

                hydroxyls.forEach(oh => {
                    oh.addEventListener('click', (e) => {
                        e.stopPropagation(); // prevent bubbling

                        if (oh.classList.contains('target-bond')) {
                            if (!oh.classList.contains('correct')) {
                                oh.classList.add('correct');
                                this.state.clicks++;

                                if (this.state.clicks === 1) {
                                    this.setInstruction("Good! Now click the other group to form water.");
                                } else if (this.state.clicks === 2) {
                                    this.setInstruction("Dehydration Synthesis Complete! H₂O Released.");
                                    setTimeout(() => {
                                        this.svg.innerHTML = '';
                                        this.drawMolecule(350, 250, 'maltose');
                                        setTimeout(() => this.levelComplete(), 2000);
                                    }, 1000);
                                }
                            }
                        } else {
                            oh.classList.add('wrong');
                            this.setInstruction("Wrong atoms! Bond C1 of one to C4 of the other.");
                            this.shakeEffect();
                        }
                    });
                });
            },

            addMonomer(type) {
                const container = document.getElementById('polymer-chain');
                const count = this.state.polymerCount;

                let cx = 0 + (count * 35);
                let cy = 0;

                if (type === 'start') {
                    const hex = this.createHexagon(0, 0, '#fff');
                    container.appendChild(hex);
                } else if (type === 'linear') {
                    const hex = this.createHexagon(cx, cy, '#00e676');
                    const bond = this.createLine(cx - 35, cy, cx, cy);
                    container.appendChild(bond);
                    container.appendChild(hex);
                } else if (type === 'branch') {
                    cy = -35;
                    cx = cx - 35;
                    const hex = this.createHexagon(cx, cy, '#ff1744');
                    const bond = this.createLine(cx, cy + 35, cx, cy);
                    container.appendChild(bond);
                    container.appendChild(hex);
                    this.setInstruction("Alpha 1-6 Branch created!");
                }

                this.state.polymerCount++;
                if (this.state.polymerCount > 5) {
                    setTimeout(() => this.triggerBossBattle(), 1000);
                }
            },

            createHexagon(x, y, color) {
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("transform", `translate(${x},${y})`);
                const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                poly.setAttribute("points", "-12,0 -6,-10 6,-10 12,0 6,10 -6,10");
                poly.setAttribute("fill", color);
                g.appendChild(poly);
                return g;
            },

            createLine(x1, y1, x2, y2) {
                const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                l.setAttribute("x1", x1); l.setAttribute("y1", y1);
                l.setAttribute("x2", x2); l.setAttribute("y2", y2);
                l.setAttribute("stroke", "white");
                l.setAttribute("stroke-width", "3");
                return l;
            },

            // --- Win/Loss & Transitions ---

            levelComplete() {
                this.setInstruction("LEVEL COMPLETE!");

                if (this.state.level === 5) {
                    document.getElementById('modal-title').innerText = "MASTERY ACHIEVED";
                    document.getElementById('modal-text').innerText = "You have evolved from CH₂O to Glycogen. You are ready for metabolism.";
                    document.getElementById('modal').classList.add('active');
                    return;
                }

                this.triggerBossBattle();
            },

            triggerBossBattle() {
                const modal = document.getElementById('boss-modal');
                const qText = document.getElementById('boss-question');
                const options = document.getElementById('boss-options');

                modal.classList.add('active');
                options.innerHTML = '';

                const bosses = [
                    { q: "What makes a sugar 'Polyhydroxy'?", a: "Multiple -OH groups", bad: ["Multiple Carbons", "Water rings"] },
                    { q: "Why is Fructose a reducing sugar despite being a ketone?", a: "Tautomerization moves the carbonyl", bad: ["It isn't reducing", "It has 6 carbons"] },
                    { q: "Which carbon is the 'Anomeric' carbon in Glucose?", a: "C1", bad: ["C6", "C4"] },
                    { q: "In Beta-Glucose, where is the -OH group?", a: "UP (Equatorial)", bad: ["DOWN (Axial)", "Inside the ring"] },
                    { q: "What reaction links monosaccharides?", a: "Dehydration Synthesis", bad: ["Hydrolysis", "Ionic Bonding"] },
                    { q: "Why can't humans digest Cellulose?", a: "We lack enzymes for Beta 1-4 bonds", bad: ["It's too big", "It contains Nitrogen"] }
                ];

                const boss = bosses[this.state.level];
                qText.innerText = boss.q;

                const choices = [boss.a, ...boss.bad].sort(() => Math.random() - 0.5);

                choices.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'btn';
                    btn.innerText = c;
                    btn.onclick = () => {
                        if (c === boss.a) {
                            this.state.score += 100;
                            this.state.unlocked++;
                            this.updateUI();
                            modal.classList.remove('active');
                            this.startLevel(this.state.level + 1);
                        } else {
                            this.setInstruction("Incorrect! Damage taken.");
                            this.shakeEffect();
                        }
                    };
                    options.appendChild(btn);
                });
            },

            updateUI() {
                document.getElementById('score').innerText = `XP: ${this.state.score}`;
                const pct = (this.state.unlocked / 6) * 100;
                document.getElementById('xp-bar').style.width = `${pct}%`;

                for (let i = 0; i <= 5; i++) {
                    const node = document.getElementById(`btn-lvl-${i}`);
                    if (node) {
                        if (i <= this.state.unlocked) {
                            node.classList.add('unlocked');
                            node.style.cursor = "pointer";
                        }
                        if (i < this.state.unlocked) node.classList.add('completed');
                    }
                }
            },

            shakeEffect() {
                this.svg.style.transform = "translateX(5px)";
                setTimeout(() => this.svg.style.transform = "translateX(-5px)", 50);
                setTimeout(() => this.svg.style.transform = "translateX(0)", 100);
            },

            // --- SVG Drawing Helpers (The Chemistry Engine) ---

            drawMolecule(x, y, type, idOverride) {
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("id", idOverride || `mol-${type}`);
                g.setAttribute("transform", `translate(${x},${y})`);

                if (type.includes('linear')) {
                    // Draw Linear Carbon Backbone
                    for (let i = 0; i < 6; i++) {
                        let cy = i * 50;
                        if (i < 5) this.drawBond(g, 0, cy, 0, cy + 50);

                        let interactionType = "carbon";
                        if (type === 'linear_fructose' && i === 1) interactionType = "ketone";
                        if (type.includes('glucose') && i === 0) interactionType = "aldehyde";

                        const atomGroup = this.drawAtomGroup(0, cy, "C", interactionType);

                        if (type === 'linear_glucose_numbered') {
                            atomGroup.addEventListener('click', (e) => {
                                e.stopPropagation();
                                this.handleCarbonClick(i + 1, atomGroup);
                            });
                        }
                        g.appendChild(atomGroup);

                        // Draw Functionals
                        if (interactionType === "aldehyde") {
                            this.drawBond(g, 0, cy, 30, cy - 20);
                            const o = this.drawAtomGroup(30, cy - 20, "O", "carbonyl");
                            g.appendChild(o);
                        } else if (interactionType === "ketone") {
                            this.drawBond(g, 0, cy, 30, cy);
                            const o = this.drawAtomGroup(30, cy, "O", "carbonyl");
                            g.appendChild(o);
                        } else {
                            this.drawBond(g, 0, cy, 30, cy);
                            const oh = this.drawAtomGroup(30, cy, "OH", "hydroxyl");
                            g.appendChild(oh);
                        }
                    }
                }
                else if (type.includes('alpha_glucose') || type.includes('beta_glucose')) {
                    // Haworth Projection Points
                    const coords = [
                        { x: 50, y: 0 }, { x: 100, y: 30 }, { x: 100, y: 80 },
                        { x: 50, y: 110 }, { x: 0, y: 80 }, { x: 0, y: 30 }
                    ];

                    // Draw Ring Bonds
                    for (let i = 0; i < 6; i++) {
                        let next = (i + 1) % 6;
                        this.drawBond(g, coords[i].x, coords[i].y, coords[next].x, coords[next].y);
                    }

                    // Oxygen in Ring
                    const oRing = this.drawAtomGroup(100, 30, "O", "ether");
                    g.appendChild(oRing);

                    // --- C1 (Right Side) ---
                    const c1 = this.drawAtomGroup(100, 80, "C", "carbon");
                    g.appendChild(c1);

                    // Alpha/Beta OH Logic
                    const isAlpha = type.includes('alpha');
                    const ohY = isAlpha ? 110 : 50;
                    this.drawBond(g, 100, 80, 100, ohY);

                    const oh1 = this.drawAtomGroup(100, ohY, "OH", "hydroxyl");
                    g.appendChild(oh1); // This is C1-OH

                    // --- C4 (Left Side) - THIS WAS MISSING ---
                    const c4 = this.drawAtomGroup(0, 80, "C", "carbon");
                    g.appendChild(c4); // Fix: Append C4 atom

                    this.drawBond(g, 0, 80, 0, 110); // Bond down
                    const oh4 = this.drawAtomGroup(0, 110, "OH", "hydroxyl");
                    g.appendChild(oh4); // Fix: Append C4-OH (The click target)

                    // --- C6 (Top Branch) ---
                    this.drawBond(g, 0, 30, -20, 0);
                    const c6 = this.drawAtomGroup(-20, 0, "CH2OH", "hydroxyl");
                    g.appendChild(c6); // Fix: Append C6
                }
                else if (type === 'maltose') {
                    const bondT = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    bondT.setAttribute("x", 0); bondT.setAttribute("y", -30);
                    bondT.setAttribute("fill", "var(--lvl4-purple)");
                    bondT.setAttribute("text-anchor", "middle");
                    bondT.setAttribute("font-size", "24px");
                    bondT.textContent = "α(1→4) Bond Formed";
                    g.appendChild(bondT);
                    this.createPolymerVis(g);
                }

                this.svg.appendChild(g);
            },

            createPolymerVis(g) {
                // Simple visual for result
                const c1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                c1.setAttribute("r", 40); c1.setAttribute("cx", -50); c1.setAttribute("fill", "none"); c1.setAttribute("stroke", "white");
                const c2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                c2.setAttribute("r", 40); c2.setAttribute("cx", 50); c2.setAttribute("fill", "none"); c2.setAttribute("stroke", "white");
                const link = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                link.setAttribute("r", 10); link.setAttribute("fill", "var(--lvl4-purple)");
                g.appendChild(c1); g.appendChild(c2); g.appendChild(link);
            },

            drawAtomGroup(x, y, label, type) {
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", "atom");
                g.setAttribute("transform", `translate(${x},${y})`);
                g.setAttribute("data-type", type);

                const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                c.setAttribute("r", 15);

                const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
                t.textContent = label;
                t.setAttribute("y", 1);

                g.appendChild(c);
                g.appendChild(t);

                // Add svg to canvas temporarily to ensure it renders? 
                // No, we append the Group later.
                return g;
            },

            drawBond(parent, x1, y1, x2, y2) {
                const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
                l.setAttribute("x1", x1); l.setAttribute("y1", y1);
                l.setAttribute("x2", x2); l.setAttribute("y2", y2);
                l.setAttribute("class", "bond");
                parent.appendChild(l);
            }
        };

        // Start Game
        Game.init();

    </script>
</body>

</html>
